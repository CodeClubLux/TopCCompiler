import "http"

ext node _read: |string| do Maybe[string] = "server_readFile"
ext node quit: |int| -> string = "process.exit"

def read(path: string) string do
    match _read path with
        Some x ->
            x
        None ->
            log "cannot find file, "+path
            quit 1

let htmlFile = read "Simulation.html"
let logo = read "images/variation.png"
let async = read "images/async.png"
let tools = read "images/tools.png"
let favicon = read "images/arrow.ico"
let error = read "images/error.png"

def query(q: Routes) http.Response do
    match q with
        Query-Docs end ->
            //replace static information with database query
            end Docs {
                overview = ["Get Started", "Examples", "How to structure your program"]
                learn = ["An Introduction to Top", "FAQ", "Syntax", "Style Guide",
                    "The Zen of Top", "Writing Documentation"]
                packages = ["All Packages", "Core", "HTML"]
                headers = headers
                footer = footer_text
            }

def requestHandler(req: http.Request) http.Response do
    log "request, "+req.url

    if (http.isQuery req.url) then
        http.handleQuery req.url, query
    elif req.url == "/" then
        http.response {body = htmlFile, content-type = "text/html"}
    elif req.url == "/arrow.png" then
        http.response {body = logo, content-type = "image/png"}
    elif req.url == "/async.png" then
        http.response {body = async, content-type = "image/png"}
    elif req.url == "/tools.png" then
        http.response {body = tools, content-type = "image/png"}
    elif req.url == "/favicon.ico" then
        http.response {body = favicon, content-type = "image/x-icon"}
    elif req.url == "/error.png" then
        http.response {body = error, content-type = "image/png"}
    else
        http.response {status= 404, body = "404 Page not found"}

ext node port: int = "process.env.PORT || 3000"

let server = http.server requestHandler

server.listen port

log "started web server on port {port}"